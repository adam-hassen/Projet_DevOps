name: CI/CD Pipeline

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpassword
          MYSQL_DATABASE: test_interface
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
      
      - name: Install MySQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y mysql-client
      
      - name: Cache dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest flake8
      
      - name: Lint with flake8
        run: |
          flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
      
      - name: Wait for MySQL
        run: |
          while ! mysqladmin ping -h"127.0.0.1" -P"3306" --silent; do
            echo "Waiting for MySQL..."
            sleep 2
          done
      
      - name: Initialize database
        run: |
          if [ -f init.sql ]; then
            mysql -h 127.0.0.1 -P 3306 -u root -prootpassword test_interface < init.sql
            echo "Database initialized successfully"
          else
            echo "init.sql not found, skipping database initialization"
          fi
      
      - name: Run tests
        env:
          DB_HOST: 127.0.0.1
          DB_USER: root
          DB_PASSWORD: rootpassword
          DB_NAME: test_interface
          DB_PORT: 3306
        run: |
          # Test simple - vérifier que l'import Flask fonctionne
          python -c "import flask; print(' Flask OK')"
          python -c "import mysql.connector; print(' MySQL Connector OK')"
          python -c "import pandas; print('Pandas OK')"
          
          # Test de connexion à MySQL en une ligne
          python -c "import os; import mysql.connector; conn = mysql.connector.connect(host=os.environ.get('DB_HOST'), user=os.environ.get('DB_USER'), password=os.environ.get('DB_PASSWORD'), database=os.environ.get('DB_NAME')); cursor = conn.cursor(); cursor.execute('SHOW TABLES'); tables = cursor.fetchall(); print(f'✅ Tables trouvées: {tables}'); cursor.close(); conn.close(); print('✅ Test de connexion MySQL réussi!')"
      
      - name: Build Docker image
        run: |
          echo "Construction de l'image Docker..."
          docker build -t gestion-clients:${{ github.sha }} .
          echo " Image construite avec succès !"
      
      - name: Simulate deployment
        run: |
          echo "==================================="
          echo " DÉPLOIEMENT SIMULÉ "
          echo "==================================="
          echo "Commande de déploiement:"
          echo "docker tag gestion-clients:${{ github.sha }} ghcr.io/${{ github.repository }}/gestion-clients:latest"
          echo "docker push ghcr.io/${{ github.repository }}/gestion-clients:latest"
          echo ""
          echo "Pour lancer l'application en production:"
          echo "docker run -d -p 5000:5000 \\"
          echo "  -e DB_HOST=production-db-host \\"
          echo "  -e DB_USER=prod_user \\"
          echo "  -e DB_PASSWORD=**** \\"
          echo "  -e DB_NAME=test_interface \\"
          echo "  gestion-clients:latest"
          echo "==================================="

  release:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Create and push tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          VERSION="v1.0.${{ github.run_number }}"
          git tag -a $VERSION -m "Release $VERSION"
          git push origin $VERSION
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
